h1. Originator Message (OGM)

??This page is work-in-progress and will state the BATMAN V algorithm later (checkout "this":http://git.open-mesh.org/?p=batman-adv-doc.git;a=summary for now)??


The B.A.T.M.A.N. protocol originally only used a single message type (called OGM) to determine the link qualities to the direct neighbors and spreading these link quality information through the whole mesh. This procedure is summarized on the [[open-mesh:BATMANConcept|BATMAN concept page]] and explained in details in "the RFC draft":http://tools.ietf.org/html/draft-wunderlich-openmesh-manet-routing-00 published in 2008.

With the new concept of a separate [[ndp|NDP]] the tasks performed by OGMs becomes way simpler: While local work is done by NDP, information gets distributed in the mesh network with the OGM protocol, in that OGMs' primary task is to advertise path qualities, without determening link qualities. OGMs also still have the important task to distribute Host Network Annoncements, HNA for short.

This bears the following advantages from the OGM point of view:
* Reduced overhead, as OGMs can then be send with a slower interval. The BATMAN routing algorithm still has a squared amount of overhead in worst case scenarios, therefore the the slower intervals are very desireable.
* The BATMAN core routing protocol becomes less entangled with other mechanisms and features, making it easier understand and to perform theoretical analysis on.
* Easier to optimize the OGMs convergence speed.


h2. Definitions

* node - A mesh router which utilizes the B.A.T.M.A.N. protocol as specified in this document on at least one network interface. A node consists of one or more originators.
* originator - An addressable entity within one mesh network routing layer. An originator's address has to be unique within a mesh network routing layer and unique on a node. A node's hard-interface may only be utilized by zero or one originator.
* B.A.T.M.A.N./hard interface - Network interface utilized by B.A.T.M.A.N. for its own ethernet frames.
* sliding window - Sequence numbers are recorded in dedicated sliding windows until they are considered out-of range. Thus, such a sliding window always contains the set of recently received sequence numbers. The amount of sequence numbers recorded in the sliding window is used as a metric for the quality of detected links and paths.
* duplicate - A received NDP message from a neighbor containing an already received sequence number.
* out of order - A received NDP message from a neighbor containing a sequence number that is older than the newest sequence number ever received from this neighbor.
* HNA - Host Network Announcement, a host's MAC address which is addressable on the mesh layer and which this originator is responsible for. This may be either the originator itself (bat0's MAC) or a bridged in host.
* Router:
* Sender: The originator belonging to a received OGM's ethernet frame source address.
* global TQ value: The linear mapping of an OGM's global TQ field to a value between 0 and 1 (global TQ / TQ_MAX = global TQ value).


h2. Protocol Procedure



h4. Broadcasting own Originator Message (OGM)

Each node periodically (OGM interval) generates and broadcasts a single OGM on each interface B.A.T.M.A.N. is running on if at least one HNA is present. A jitter may be applied to avoid collisions.

+The Originator Message (OGM) Format:+

* Packet type: Initialize this field with the OGM packet type.
* Version: Set your internal compatibility version.
* flags: Indicates certain attributes of this originator. So far 0x01 is reserved for VIS_SERVER (see [[VisAdv]])
* global TQ: Is initially set to TQ_MAX by the originator.
* Sequence number: On first broadcast set the sequence number to an arbitrary value and increment the field by one for each following broadcast.
* Originator Address: Set this field to the primary MAC address of this B.A.T.M.A.N. node.
* Previous Sender: Indicates the originator address of the sender that routed the OGM to our sender. Initially, the originator of the OGM sets it to its originator address.
* Number of HNAs: The number of hosts that are announced with this message.

<pre>
  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 | Packet Type   |    Version    |     flags     |   global TQ   |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                       Sequence Number                         |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                     Originator Address                        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |      Originator Address       |       Previous Sender         |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                       Previous Sender                         |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |      TTL      |    Num HNA    |   GW flags    |  Alignment    |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>

A B.A.T.M.A.N. originator has to advertise at least one HNA. Otherwise no OGM shall be scheduled for sending.

+The Host Network Announcement (HNA) Message Format:+

<pre>
  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                     Host Network Announcement                 |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |  Host Network Announcement    |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>

Note: An HNA entry is not 4 Byte aligned, as two 6 Bytes entries are.


h2. Receiving Originator Messages


Upon receiving a general B.A.T.M.A.N. packet a Node must perform the
following preliminary checks before the packet is further processed:

* If the OGM contains a version which is different to the own internal version the message must be silently dropped (thus, it must not be further processed).
* If the sender address of the OGM's ethernet frame belongs to one of the B.A.T.M.A.N. interfaces the message must be silently dropped as this OGM originated from this node.
* If the sender address of the OGM's ethernet frame is a multicast address the message must be silently dropped.
* If the OGM's sequence number is smaller (TODO: describe somewhere what "smaller" means here) or equal to Sender's Router Sequence Number for the OGM's Originator the message must be silently dropped. (TODO: does this make the Previous Sender field obsolete?)
* If the tuple of the origantor address, the sender's originator address and sequence number of the OGM are a duplicate the message must be silently dropped.
* If an OGM with a newer sequence number of the same originator address and sender's originator address has been received before, the message must be silently dropped.

If the OGM has not been dropped after these preliminary checks, the OGM will be modified in the following way:

* The OGM's global TQ field needs to be multiplied with the best link TQ value towards the sender.
* This new OGM's global TQ field needs to be multiplied with the asymmetric penalty of the link with the best link TQ value towards the sender. See 'TODO' for the asymmetric penalty.
* The Neighbor Ranking needs to be performed.


h2. Router Ranking

When a new neighbor ranking needs to be performed for an OGM the following steps need to be undertaken:

* If the OGM's Sequence Number is newer than the Originator's Sequence Number:
** The new Originator's Sequence Number must be set to the Sequence Number contained in the received OGM.
** for all Routers of the OGM's originator: if (Originator's Sequence Number - Router's Sequence Number) < OGM_SEQ_DIFF_LIMIT, purge the Neighbor Originator from the OGM's originator's Router List. (TODO: check whether this could introduce routing loops? Any additional checks for purging needed?)
* If a matching Router entry for the OGM's Sender and OGM's Originator exist, the global TQ value and Router Sequence Number in this Router entry need to be updated with the OGM's global TQ value and OGM's Sequence Number. Otherwise a Router entry with these values needs to be created.
* If the OGM's global TQ value is the best of all other Router's global TQ values, the OGM needs to be re-broadcasted.

TODO: Add a picture of the automata? (If that's not easily doable, simplify the Neighbor Ranking section, and out-source certain things to Pre/Post-Checks that do not modify the Originator List)


h2. Re-broadcasting other nodes' OGMs


When an OGM is to be re-broadcasted some of the message fields must be changed others must be left unchanged.  All fields not mentioned in the following section remain untouched:

* The TTL must be decremented by one. If the TTL becomes zero (after the decrementation) the packet must be dropped.
* The OGMs global TQ field needs to be multiplied with the hop penalty. See 'TODO' for the hop penalty.
* 


h2. Originator List

* Originator:
* Originator's Sequence Number: The newest OGM Sequence Number that has been accepted from the given Originator. This is described in 'TODO'
* Router List: A list of possible routers towards an originator


h3. Router List

* Originator:
* global TQ value: The global TQ value towards the
* Router's Sequence Number:


h2. Proposed Values for Constants


OGM_SEQ_DIFF_LIMIT: 5

TQ_MAX: 255

----

h1. Questions

* Does also the aggregation have to be reimplemented then...? Or should that be removed and reimplemented later after the GSoC?
* Do we really need to check for the sender address of an OGM to see whether it was our own one and whether we should drop it? The duplicate checks should come to the same conclusion, shouldn't it?
* Is the previous sender really needed?
* According to the batman-doc, the reason of substituting an OGMs TQ with the chosen neighbor's best one was to improve the asymmetric case, where the OGM propagation (over several hops) can be quite bad. Which is not loopsafe and added the previous sender field for echo cancellation (which only works for two but not for more than two nodes??). What should / should something else be done instead? Maybe a node could measure its asymmetricity towards its neighbors and increase its number of OGM rebroadcasts if for most neighbors link RQ * asym_penalty >> link TQ? For instance the formula: [...]
* Should the OGM - BATMAN V structure already contain the HNA and multicast improvement data fields? (their concepts are finalized and a lot of it already implemented)

----

h1. Changes between OGMs in BATMAN IV and BATMAN V

h2. Renaming

* Global TQ renamed to Path TQ
* Local TQ renamed to Link TQ

h2. Removal of Global TQ Window and gl. TQ Averaging

Only remember last Path TQ and its sequence number as well as the highest
sequence number of an originator node received. The window size is substituted by a
SEQ_DIFF_MAX (default: 5). A neighbor node is being purged from the router list
if orig_node->last_seqno - router->last_seqno > SEQ_DIFF_MAX.

h2. Removed previous sender field

h2. Bonding Mode using NDP's link qualities

h2. Removal of secondary interface originators

Instead when receiving an OGM, always the best link quality measured by NDP
will be substracted from the OGM. This shall make multiple interfaces
transparent from the OGM algorithm.

h2. Removal of PRIMARIES_FIRST_HOP + DIRECTLINK flag

PRIMARIES_FIRST_HOP flag is no more needed as there will be just one primary originator a.k.
originator.

h2. Removal of bidirectional link check

Asymetric Penalty should be better and enough.

h2. (Re)Introduce strict OGM forwarding policy

To avoid routing loops. MGO/batping mechanism will compensate for convergence speed performance.

h2. Increase NDP window size to 128 packets

With removing the Path TQ averaging, things will get too unstable otherwise. Should be                                                                       
later substituted with an EWMA [1].

----

h1. Further Optimizations

h2. Positive Feedback OGM rebroadcasting

When for any originator the link TQ of the according, chosen next hop router increased by 30%25 points compared to the link quality used for the last rebroadcasted OGM, resend the same OGM but with the path TQ multiplied with the new, better link TQ value instead.
