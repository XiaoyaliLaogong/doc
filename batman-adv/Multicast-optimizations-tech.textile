h1. Basic Multicast Optimizations – Technical Description

Prior Readings:

 * [[Basic-multicast-optimizations|Basic Multicast Optimizations]]

h2. Multicast Listener Announcements

!{width: 66%25;}basic-multicast-listener-announce.png!

The IPv4/IPv6 multicast code in the Linux kernel keeps track of any of its applications requesting to receive multicast packets for a certain group.

batman-adv queries this local database and announces these so called multicast listeners, more precisely the according multicast MAC addresses, to the rest of the mesh network via the [[open-mesh:2012-05-13-translation-table-in-a-nutshell|translation table infrastructure]].

h2. Multicast TVLV

A node capable of performing Multicast Listener Announcements signalizes this by attaching a Multicast TVLV to its OGMs.


h3. Multicast TVLV format

<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 | MCAST Flags   |                 Reserved                      | 
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>


h4. BATADV_MCAST_WANT_ALL_UNSNOOPABLES (Bit 0):

Signalizes that this node wants all unsnoopable multicast traffic, that is traffic destined to the all-nodes address for IPv6 (ff02::1) and to link-local addresses for IPv4 (224.0.0.0/24). This is usually the case when a node uses a bridge device on top of bat0 and is therefore unable to detect potential bridged-in listeners.

(not used by listeners yet, but implemented for senders already to ensure backwards compatibility later, see [[Basic-multicast-optimizations-flags#BATADV_MCAST_WANT_ALL_UNSNOOPABLES]] for details)

h4. BATADV_MCAST_WANT_ALL_IPV4 (Bit 1):

Signalizes that this node wants all IPv4 multicast traffic. This is usually the case when a node uses a bridge device on top of bat0, has an IGMP querier (no matter if IGMPv2 or IGMPv3) behind it and is therefore not able to reliably determine all of its IGMPv2 listeners.

(not used by listeners yet, but implemented for senders already to ensure backwards compatibility later, see [[Basic-multicast-optimizations-flags#BATADV_MCAST_WANT_ALL_IPV4-BATADV_MCAST_WANT_ALL_IPV6]] for details)

h4. BATADV_MCAST_WANT_ALL_IPV6 (Bit 2):

Signalizes that this node wants all IPv6 multicast traffic. This is usually the case when a node uses a bridge device on top of bat0, has an MLD querier (no matter if MLDv1 or MLDv2) behind it and is therefore not able to reliably determine all of its MLDv1 listeners.

(not used by listeners yet, but implemented for senders already to ensure backwards compatibility later, see  [[Basic-multicast-optimizations-flags#BATADV_MCAST_WANT_ALL_IPV4-BATADV_MCAST_WANT_ALL_IPV6]] for details)

h4. Bits 3 to 7:

reserved for future extensions

h2. Multicast Sender

!{width: 66%25;}basic-multicast-sender-receiver.png!

Optimization for IPv4 or IPv6 multicast packets is performed by considering a few special cases. First, the number of nodes interested in a group is counted. Interest has been announced by either including the multicast group in TT entries, or setting the BATADV_MCAST_WANT_ALL_IPV4 or BATADV_MCAST_WANT_ALL_IPV6 flags in the Multicast TVLV flag.

If the total number of nodes interested in a group is:

 * ... 0, then this frame can be safely dropped.
 * ... 1, then this frame is encapsulated in and forwarded via a batman-adv unicast packet to the according destination.
 * > 1, then this frame is encapsulated in a batman-adv broadcast packet and forwarded via classic flooding to all nodes.

The latter case is the general fallback to broadcast, which is also used when the the multicast optimization is turned off.

h3. Handling rules depending on multicast address

Depending on the IP destination of the multicast packet and if there are mesh nodes with the BATADV_MCAST_WANT_ALL_UNSNOOPABLES flag set, there are various limitations and exceptions. If multicast optimization is not supported for whatever reason, the packets will be sent as broadcast as a fallback solution.

| address space       | addresses     | status | comment |
| IPv4 link-local        | 224.0.0.0/24 | optimized if no host has WANT_UNSNOOPABLES| No IGMP  is required to announce group membership, therefore the bridge can't snoop if there are listeners|
| IPv4 routed addresses | 224.0.0.0/16 without 224.0.0.0/24 | not optimized | 
| IPv6 all-nodes       | ff02::1          | optimized if no host has WANT_UNSNOOPABLES | No MLD is required to announce group membership, therefore the bridge can't snoop if there are listeners|
| .... | | |


h3. unsnoopable link local multicast addresses

Note that there is a special case for unsnoopable multicast traffic. If the destination IP address is the all-nodes address for IPv6 (ff02::1) or to link-local addresses for IPv4 (224.0.0.0/24), the packets are only set if *not a single node* has set BATADV_MCAST_WANT_ALL_UNSNOOPABLES bit in their Multicast TVLV. These multicast IPs don't require IGMP or MLD to announce group membership, hence batman-adv on these nodes can't know if they have multicast listeners behind them or not.


h2. Limitations

 * No Bridge mode: So far a node with a Linux bridge on top of its batman-adv interface is not capable of detecting and announcing multicast listeners behind its bridge. Therefore such nodes do not attach a Multicast TVLV to their OGMs.
 * groups with two or more listeners don't get optimized
 * the whole mesh must have multicast support enabled
 * optimization for traffic of scope greater than link-local is not supported yet
 * optimization for link-local IPv4 (224.0.0.0/24) or all-nodes IPv6 multicast (ff02::1) is only done if no node announces BATADV_MCAST_WANT_ALL_UNSNOOPABLES, that is no node configures a  bridge on batman-adv.
 * high multicast join/leave latency in setups with slow OGM intervals
 * no awareness for source-specific multicasts

h2. Next Steps / Roadmap

 * Linux bridge support:
 ** Snoop/memorize ports with queriers behind
 ** Export listeners/queriers to batman-adv
 * optimization for groups with two or more members:
 ** many-to-some: implement batman-adv multicast packet type supporting a list of destination addresses (to reduce ICMPv6 overhead like Neighbor Solicitatiion Messages, Router Solicitation Messages, MLD Reports, ...)
 ** some-to-many / streaming: implement path tracking and use these patches (see [[Multicast-ideas-updated]])
 * implement router discovery to support scopes greater than link-local, too
 * implement some faster listener roaming mechanism for bridged in hosts (for instance announce (multicast-address, source address) pairs and use general TT roaming mechanism)
 * perform multicast listener adition/reduction via TT immediately instead of every OGM interval to reduce join/leave latency in setups with a slow OGM interval
 * implement source-specific multicast in Linux bridge and batman-adv
 * ...

h2. Further Readings

* [[Basic-multicast-optimizations-flags|Basic Multicast Optimizations – Flags Explained]]