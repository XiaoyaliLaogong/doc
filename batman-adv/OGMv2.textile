h1. Originator Message (OGM)

??This page is work-in-progress and will state the BATMAN V algorithm later.??
It is a rework based on the original [[OGM]] page and will supercede it after completion.

h2. 1. Introduction

[[batman_v|B.A.T.M.A.N. V]] uses the Originator Messages 2 (OGM2) to make routing decisions and  transport information about mesh participants through the whole mesh. It is complemented by the [[ELP|Echo Location Protocol(ELP)]] which is used for neighbor sensing. The previous versions of the B.A.T.M.A.N. protocols (version I to IV) used the original OGM messages for both neighbor sensing and route finding.

The new OGM2 protocol bears the following advantages:

 * Reduced overhead, as OGMs can then be sent with a slower interval. The BATMAN routing algorithm still has a squared amount of overhead in worst case scenarios, therefore the the slower intervals are very desireable.
 * Neighbor sensing and metric data collection can be performed individually, at different intervals or even different techniques
 * Efforts for multiple interfaces handling can be reduced
 * The BATMAN core routing protocol becomes less entangled with other mechanisms and features, making it easier understand and to perform theoretical analysis on.

h2. 2. Definitions

* Node - A mesh router which utilizes the B.A.T.M.A.N. protocol as specified in this document on at least one network interface.
* originator - A node broadcasting its own OGMs that is therefore addressable within the mesh network routing layer. It is uniquely identifiable by its originator address. B.A.T.M.A.N.-Advanced uses the MAC address of its primary hard interface.
* hard interface - Network interface utilized by B.A.T.M.A.N. for its own ethernet frames.
* Neighbor: An originator within one hop distance.
* Router: A neighbor which is a potential, loop-free next hop for forwarding data packets towards a specific originator.
* link throughput: link throughput from one interface to a neighbor's interface (see [[ELP]] for details).
* best link throughput: The best of all link throughput values towards a neighbor (see [[ELP]] for details).
* path throughput:  The incoming OGM's throughput combined with the best link throughput of the according neighbor.
* Originator entry: Local data structure in the originator list (see 'Conceptual Data Structures' for details).
* Router entry: Local data structure in the router list (see 'Conceptual Data Structures' for details).

Throughputs are specified in units of 100 kbit/s.

h2. 3. Conceptual Data Structures

h3. 3.1. Originator List

An originator list holds all addressable and to a certain degree reachable originators within the mesh network. The Originator Address and Selected Router fields of this list are of special interest for the actual routing decisions upon incoming data packets.

* Originator Address: The originator address of the node.
* Originator's Sequence Number: The newest OGM Sequence Number that has been accepted from the given Originator.
* Router List: A list of potential routers towards an originator
* Selected Router: A router from the Router List which is chosen as the next hop to forward data packets to for the according originator.

h3. 3.2 Router List

A router list holds all potential routers, routers that might be switched to at any time without creating a routing loop. An entry buffers the newest, valid OGM2 from the according router and according originator of the OGM2 to be able to rebroadcast an OGM2 later when switching to another potential router.

* Router Originator Address: Originator address of the router an OGM2 was received from.
* Received OGM2, the following properties are of special interest for the routing decisions:
** Path throughput: The path throughput towards the originator of the OGM2 multiplied with the best link throughput at the time of reception.
** Router's Sequence Number: The sequence number of the last accepted OGM received via the according router.
* As well as all other properties of the OGM2 like:
** Interval, Flags, Gateway Flags, TT Num Changes, TT VN, TT CRC and a possible TT change entry (see [[Client-announcement]] for TT related field descriptions)

h2. 4. Protocol Procedure

h3. 4.1 Broadcasting own Originator Message 2 (OGM2)

Each node periodically (OGM interval) generates a single OGM which is broadcasted on all hard interfaces. A jitter may be applied to avoid collisions.

+The Originator Message 2 (OGM2) Format:+

 * Packet type: Initialize this field with the ELP packet type.
 * Version: Set your internal compatibility version.
 * TTL: Initialize with BATADV_TTL
 * Flags: not used
 * Sequence number: On first broadcast set the sequence number to an arbitrary value and increment the field by one for each following OGM2.
 * Originator Address: Set this field to the primary MAC address of this B.A.T.M.A.N. node.
 * TVLV length: Length of the TLVL data appended to the OGM
 * Throughput: Throughput metric value in 100 kbit/s. Initialize with BATADV_THROUGHPUT_MAX_VALUE
 * TVLV data: Appended TVLV data for the originator. See [[TVLV]] for a detailed description.

<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 | Packet Type   |    Version    |      TTL      |   Flags       |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                       Sequence Number                         |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                     Originator Address                        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |  (cont'd) Originator Address  |  TVLV length                  |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                         Throughput                            |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                        TVLV data ...                          |
</pre>


h3. 4.2. Receiving Originator Messages

Upon receiving an OGM a node must perform the following checks before the packet is further processed:

h4. 4.2.1. Preliminary Checks

The following checks are simple sanity checks which don't affect the routing logic: 

* *Version Check:* If the OGM contains a version which is different to the own internal version the message must be silently dropped (thus, it must not be further processed).
* *Source Check:* If the sender address of the OGM is an ethernet multicast (including broadcast) address the message must be silently dropped.
* *Destination Check* If the destination address of the OGM is a unicast address which does not match the received interface MAC address, the message must be silently dropped.
* *Own Message Check:* If the originator address of the OGM is our own the message must be silently dropped as this OGM originated from this node.

h4. 4.2.2. Metric Update

The following steps check whether the Neighbor we received the OGM2 from is a potential Router. 

Each step is performed per potential outgoing interface where the OGM2 may be rebroadcasted to allow [[Multi Link Optimizations]]. This a *default* interface next to the configured hard interfaces, which is used for locally generated traffic.

The following checks are performed before updating the metric:

 * Protection window check: If the OGM2s sequence number is older than BATADV_OGM_MAX_AGE or newer than the BATADV_EXPECTED_SEQNO_RANGE, and the protection window is active, the packet is silently dropped. If both conditions are met but the protection window is not active yet, the OGM2 is allowed but the protection window gets activated.
 * If the sequence number is strictly older than the last OGM2, the packet is silently dropped. The only exception is when the protection window has just been activated, then the OGM2 can pass.

If the initial checks above have passed, the internal stats are updated:

 * the last seen timestamps of the router and the originator are updated
 * the last sequence number and ttl values are adopted
 * Path Throughput is adopted if its lower than the link throughput to the neighbor, otherwise the link throughput is adopted
 * Forward penalties are applied:
   * if the considered interface is the *default* interface, no penalty is applied
   * if the incoming and considered outgoing interface is the same *half duplex* interface and the reported throughput is larger than 1 MBit/s, the throughput is reduced by 50%
   * Otherwise, a hop penalty is applied and the throughput is reduced by the according value (default 5.8% or 15/255). This is especially useful for "perfect" networks to create a decreasing metric over multiple hops.
 * The throughput value with the penalties applied is stored for the router

h4. 4.2.3. Route Update

After that, we check the OGM2 whether a router update should be done and the OGM2 should be rebroadcasted

 * If the received neighbor is not (yet) a router, drop the OGM2
 * If the OGM2 sequence number is not newer than the last received one and if the throughput is not better, drop the OGM2

The passing OGM2 will be considered for a router update:

 * If the OGM2 has been received from the best router, no change is necessary
 * If the throughput from the received router is higher than the throughput via the selected router, the received router becomes the  selected router
 * Also, if the sequence number is by OGM_MAX_ORIG_DIFF higher than the last received sequence number from the selected router, the received router becomes the selected router.

If the OGM2 has been received by the (now) selected router, the OGM is forwarded on the considered outgoing interface (except for the *default* interface).

Furthermore, TVLV data is processed when this OGM2 was newer than previously received OGM2s.

h3. 5. Re-broadcasting other nodes' OGM2s

When an OGM2 is to be re-broadcasted some of the message fields must be changed others must be left unchanged.  All fields not mentioned in the following section remain untouched:

 * The TTL must be decremented by one. If the TTL becomes zero (after the decrementation) the packet must be dropped. 
 * The Path throughput for the considered outgoing interface is adopted

The OGM2 is then rebroadcasted on the specific outgoing interface.

h2. 8. Values for Constants

BATADV_THROUGHPUT_MAX_VALUE: 0xFFFFFFFF
BATADV_TTL: 50
OGM_MAX_ORIG_DIFF: 5
BATADV_OGM_MAX_AGE: 64
BATADV_EXPECTED_SEQNO_RANGE: 65536