h1. FAQ


If you are missing a question/answer (quite likely) please use the [[MailingList|BATMAN mailing list]] or [[IRC|IRC channel]] to trigger us.


h2. Does B.A.T.M.A.N. have simulator (NS2, Omnet++, etc) support?


At this point no B.A.T.M.A.N. implementation (we know of) supports simulators like the ones mentioned above. However, some people experiment with B.A.T.M.A.N. using emulators (UML/Qemu/etc). If you are looking for step-by-step instructions to install such a system you can [[Emulation|read our emulation document]].


h2. How to make my mesh network secure ?


What kind of security do you need? Security is a big field. Maybe you just mean encryption and authentication.....

When you only want to make the whole wlan stuff unreadable for the outside, you could just use WPA_NONE or IBSS RSN. But this doesn't resolve the problem that the key could leak and make the mesh attackable - but that is something which could always happen. So it is probably not a solution for wifi community projects, but for mesh networks controlled by a company.

There are other ideas for traffic over batman-adv. Just forget about encrypting your data on the wifi layer, but instead do everything some layers above. Some people experimented with the idea of implementing the needed authentication and encryption over IPsec. 

And most of the encryption and authentication stuff has to be resolved by the user and not by the network provider. This means https for sensible data instead of http, ssh instead of telnet, pop3s instead of pop3 and so on.

So it really depends what you want and cannot be resolved in a "security for everything, against any attack and for every purpose" blob.


Anyway, if what you need is get link between batman-adv nodes ciphered using IBSS-RSN (What is WPA2), let's see an example. However, before beginning with the process, you must know four basics points about IBSS-RSN and wpa_supplicant:  


* At least kernel 3.2 is needed, but we'll use the latest stable, 3.4.
* You'll need a wireless interface. In this example we use atheros ath9k, but it should work with ath5k as well. If you use any other chipset/driver, some steps of this tutorial may differ.
* wpa_supplicant version used for this tutorial is the one at the repository on 06/11/2012.
* Don't get mad, +iwconfig wlanX+ will always show +Encryption key:off+, but communication is ciphered.

For this example we assume two nodes, so every step from here to configuring network are the same for both nodes.

Distro used in the example is Ubuntu Server 12.04 LTS x86. Its default kernel version is 3.2, so let update kernel to 3.4. Just after installing Ubuntu:

* Installing kernel 3.4 on Ubuntu Server 12.04
** Add repositories below to file /etc/apt/sources.list.d/kernel_3.4.list

@sudo vim /etc/apt/sources.list.d/kernel_3.4.list@
@deb http://security.ubuntu.com/ubuntu quantal-security main universe restricted multiverse
deb http://it.archive.ubuntu.com/ubuntu/ quantal-updates main universe restricted multiverse
deb http://it.archive.ubuntu.com/ubuntu/ quantal main universe restricted multiverse@


** Update apt database
@sudo apt-get update@

** Install the kernel
@sudo apt-get install linux@

** Delete repositories added before
@sudo rm /etc/apt/sources.list.d/kernel_3.4.list@

** Update again apt database
@sudo apt-get update@

** Update grub to be able to start with the new kernel.
@sudo update-grub@

** Restart and boot with kernel 3.4
@sudo reboot@

* Now we are going to install the dependencies that wpa_supplicant needs to compile
@sudo apt-get install -y libssl-dev libnl-dev@

** Now it's time to install basics tools to compile wpa_supplicant (and vim… :P)
@sudo apt-get install -y build-essential git vim@


* Now, if everything went as expected, wpa_supplicant will compile at first.
** Let's go home
@cd@

** Download wpa_supplicant from it's repositories
@git clone git://w1.fi/srv/git/hostap.git@

** wpa_supplicant is inside hostapd project and both are downloaded with the previous command, so let's cd into wpa_supplicant dir
@cd hostap/wpa_supplicant@

** Now we need to create default config file
@cp defconfig .config@

** Compiling time! On 06/11/2012 there's no error or warning in the make output.
@make@

** Installing wpa_supplicant
@sudo make install@

** Let's check that wpa_supplicant in the path of the system is the one we have just compiled, and no other previous version installed in the system
@ls -lha `which wpa_supplicant`@


* The next step is configure wpa_supplicant
** Let's create and edit /etc/wpa_supplicant.conf
@vim /etc/wpa_supplicant.conf@

** Assuming ssid and psk can be changed, but must be the same in *EVERY NODE*, the file must contain:


@ctrl_interface=/var/run/wpa_supplicant-wlan01@
@ap_scan=2@
@network={@
@   scan_ssid=1@
@   ssid="MeshSSID"@
@    mode=1@
@    key_mgmt=WPA-PSK@
@    proto=RSN@
@    psk="0123456789"@
@    * Channel 01 : 2412 Mhz 11g@
@    * Channel 02 : 2417 Mhz 11g@
@    * Channel 03 : 2422 Mhz 11g@
@    * Channel 04 : 2427 Mhz 11g@
@    * Channel 05 : 2432 Mhz 11g@
@    * Channel 06 : 2437 Mhz 11g@
@    * Channel 07 : 2442 Mhz 11g@
@    * Channel 08 : 2447 Mhz 11g@
@    * Channel 09 : 2452 Mhz 11g@
@    * Channel 10 : 2457 Mhz 11g@
@    * Channel 11 : 2462 Mhz 11g@
@    frequency=2412@
@}@


** Now let's launch wpa_supplicant! Remember, every steps from the beggining to here must be executed in both nodes. 
@wpa_supplicant -c /etc/wpa_supplicant.conf -D nl80211 -i wlan0@ -d

* If there is any output saying:
@random: Only XX/20 bytes of strong random data available from /dev/random@
@random: Not enough entropy pool available for secure operations@
@WPA: Not enough entropy in random pool for secure operations - update keys later@

You can use this workaround:
@mv /dev/random / dev/random.orig@
@ln -s /dev/urandom /dev/random@


* Configuring the network.
* Node A:
** @ifconfig wlan0 192.168.10.1@

** Node B:
*** @ifconfig wlan0 192.168.10.2@


* Test our IBSS RSN connection from node A:
@ping 192.68.10.2@


Now let's download, compile, install and configure batman-adv module and batctl tool in our nodes, so following steps must be executed in both machines
** Create a directory in your home
@cd@
@mkdir batman-adv@
@cd batman-adv@

** Download the last stable version of batman-adv, you can find it here http://www.open-mesh.org/wiki/open-mesh/Download
@wget http://downloads.open-mesh.org/batman/stable/sources/batman-adv/batman-adv-2012.1.0.tar.gz@

** Unpack it
@tar zxvf batman-adv-2012.1.0.tar.gz@

** Get into and begin compilation
@cd batman-adv-2012.1.0@
@make@

** Install the module
@sudo make install@

** and now load the module
@sudo modprobe batman-adv@

Now we need batctl tool to manage our module, interfaces and so on…
** Download soources from http://www.open-mesh.org/wiki/open-mesh/Download too
@cd@
@cd batman-adv@
@wget http://downloads.open-mesh.org/batman/stable/sources/batctl/batctl-2012.1.0.tar.gz@

** Unpack it
@tar zxvf batctl-2012.1.0.tar.gz@

** Compiling…
@cd batctl-2012.1.0@
@make@

** And finally we have to install batctl too
@sudo make install@

** If everything went as expected now we can add interfaces to batman-adv
batctl if add wlan0

 

To test out batman-adv implementation we are going to ping node A from node B using batctl
** We need mac address of wlan0 in node A
@ifconfig wlan0 | grep wlan0 | awk '{print $NF}'@


** Let's assume wlan0 mac address of node A is: aa:bb:cc:dd:ee:ff, in node B
@batctl ping aa:bb:cc:dd:ee:ff@



If the output is:
@PING aa:bb:cc:dd:ee:ff (aa:bb:cc:dd:ee:ff) 20(48) bytes of data@
@20 bytes from aa:bb:cc:dd:ee:ff icmp_seq=4 ttl=50 time=1.28 ms@
@20 bytes from aa:bb:cc:dd:ee:ff icmp_seq=5 ttl=50 time=2.03 ms@
@20 bytes from aa:bb:cc:dd:ee:ff icmp_seq=6 ttl=50 time=1.24 ms@
@20 bytes from aa:bb:cc:dd:ee:ff icmp_seq=7 ttl=50 time=1.24 ms@

Everything is OK and our batman-adv implementation is running allright!


It's very important to remember you must set IP address to bat0 interface, and not phisical ones… We just did it for testing purposes.



h2. Can batman-adv run on interfaces in AP / Station / etc mode ?

batman-adv doesn't know anything about stuff below the ethernet interface. So you could also use it over layer 2 ethernet tunnels, wifi ap, wifi sta, wifi adhoc, ethernet or even write a virtual interface which prints everything on paper and scans the paper on the remote machine (but you should be fast or increase the ogm interval).

h2. How can I connect non-mesh clients to my batman-adv network ?

The [[batman-adv:Quick-start-guide|batman-adv quick-start-guide]] explains how to bridge your standard AP / Ethernet interfaces with bat0 which can be problematic if you only possess one WiFi card. In these cases it might be desirable to run adhoc mode and AP mode at the same time. Fortunately, some WiFi chips / drivers support a so-called "multi VAP" (virtual AP) or "multi SSID" mode to have multiple WiFi networks on the same WiFi interface.

h2. Why does batman need so much time to detect a "dead" node ?

Or: Why can I see a node in the originator table a long time after it died ?

Or: Does batman really need 200 seconds (PURGE_TIMEOUT) to switch the route ?

Batman switches the route as soon as it learns about a better path towards a destination which can take a fraction of a second up to several seconds very much depending on the settings and situation. When no more new originator messages are sent by a node (because it died), no more routing updates regarding this node are exchanged. Batman will not immediately delete this node from its database because the connection could just have a temporary problem and might recover. Only after a timeout period of (currently) 200 seconds the node is removed entirely from batman's internal database. It does not hurt to give the node a little extra time to recover from a connection loss as it speeds up the resume process. All routes using this "lost" node as intermediate hop will have changed towards another path in the meantime and are of no concern.



h2. Understanding the version and compatibility number


The version number (defined as SOURCE_VERSION in the source)is the one displayed when launching the batmand in debug mode. It indicates the state of your code.

The compatibility number (defined as COMPAT_VERSION in the source) is transmitted with every broadcasted OGM to guide other batmand instances receiving this OGM whith the decision about incompatible protocol versions.



h2. Why are multiple interfaces problematic?


The internet (and most network technology today) was designed with the idea that every interface on a given system has a unique broadcast adress. When a packet enters a system the kernel has to decide where it should be routed to. While using the same broadcast adresses on different interfaces you provoke an undefined situation as this should not happen (by design) and the result is unpredictable. In that case the Linux kernel will send all your packages to the first interface (in the routing table) with that broadcast address.

A solution to that problem is the usage of the Linux kernel option "BINDTODEVICE" which allows to specify an outgoing interface for a packet. Unfortunatly this option is a Linux-only feature (as far as we know). Therefore you won't be able to use multiple interfaces with the same broadcast addresses on other operation systems than Linux.



h2. Log larger amounts of debug messages


First, install netcat on your device. On a OpenWRT based distro you can try this (packet version may vary):

<pre>
ipkg install http://www.linuxops.net/ipkg/netcat_0.7.1_mipsel.ipk
</pre>

Then start batmand and pipe the output into netcat:

<pre>
batmand -d 4 <your_interfaces> | nc -l -p <any_unused_port>
</pre>

Finally start the netcat client on your logging server and save the output:

<pre>
nc <IP_of_your_device> <your_unused_port_from_step_2> > batman.log
</pre>

If you use a firewall, NAT or any other problematic network setup you can swap the netcat server position. Beware: Your netcat server has to be started before you start your netcat client.



h3. Update many Openwrt based systems


   1. Download the update script: "update script":http://downloads.open-mesh.org/batman/useful-scripts-and-tools/update_batman.sh
   2. Edit the the variables in the configuration section of the script to match your needs.
   3. Run the script. ;-)


Note: The HOSTS_TO_UPDATE variable in the script expects SSH host names which must be configured in your ~/.ssh/config file.

Tip: Use key based access to authenticate your login request on your machines to avoid typing your passwords too often. If you use encrypted keys you can enable the ssh-agent to manage your passwords.



h2. What is the batgat kernel module good for?


The batman daemon maintains a tunnel connection to every "batman internet client". Every packet that goes to the internet or comes back has to go through this tunnel. As it is a user space tunnel a lot of copying between user space and kernel land is necessary. Depending on the number of clients and the CPU power available this might be a bottleneck.
The batgat kernel module tries to overcome this limitation. Once loaded the batman daemon will detect its presence automatically on startup. The daemon will activate the kernel module to let it handle the tunneling, hence avoiding the expensive copy operations. There is no difference between the daemon tunneling and the kernel tunneling other than that.

</pre>
